# Безопасность и эксплуатация GraphQL

**GraphQL** – это язык запросов API, который позволяет клиентам гибко запрашивать только нужные данные. В отличие от **REST API**, **GraphQL** позволяет объединять несколько запросов в один, что делает его мощным, но и уязвимым инструментом. Однако его гибкость и универсальность создают серьезные проблемы безопасности, если API не настроен должным образом. В этой статье мы разберем основные векторы атак на **GraphQL**, методы защиты и инструменты тестирования безопасности.

### Архитектура GraphQL и отличие от REST

GraphQL и REST – два подхода к построению API, но они отличаются принципами работы.

![](https://github.com/isohise/kk/blob/main/GraphQL/REST.jpg)

**REST** (Representational State Transfer) строится на основе множества эндпоинтов, каждый из которых отвечает за определенный ресурс (например, `/players`, `/teams`, `/matches`). Клиент делает несколько запросов к разным эндпоинтам, чтобы получить нужные данные. Это может привести к:

* избыточной передаче данных (`over-fetching`), когда клиент получает больше информации, чем необходимо;

* недостаточной передаче данных (`under-fetching`), когда клиенту приходится делать несколько запросов, чтобы собрать всю необходимую информацию.

**GraphQL** использует единый эндпоинт (`/graphql`), который принимает запросы на получение только необходимых данных. Клиент может запрашивать конкретные поля, избегая проблем `over-fetching` и `under-fetching`. Однако такой подход создает новые риски:

* возможность утечки скрытых данных, если схема API не настроена должным образом;

* уязвимость к сложным рекурсивным запросам, которые могут перегрузить сервер.

### Основные уязвимости в GraphQL

1. Инспекция схемы (Introspection Attack)

   GraphQL поддерживает встроенную возможность **introspection** (самоанализ), которая позволяет клиенту запрашивать структуру API, включая все доступные типы, запросы и мутации. Это удобно для разработчиков, но может стать уязвимостью, если не отключено в продакшене. Злоумышленник, получивший доступ к схеме, может использовать её для поиска скрытых API и уязвимых эндпоинтов.
  
   Запрос introspection в GraphQL Playground:

   ```javascript
   {
     __schema {
       types {
         name
         fields {
           name
         }
       }
     }
   }
   ```

   Если introspection включен, сервер вернет структуру API, позволяя атакующему анализировать потенциальные цели.

2. Инъекции в GraphQL (GraphQL Injection)

   **GraphQL-инъекции** похожи на традиционные SQL-инъекции. Они происходят, когда входные данные пользователя обрабатываются без проверки и используются для выполнения внутренних запросов.

   Пример GraphQL-инъекции:

   ```
   {
     user(id: "1 OR 1=1") {
       username
     }
   }
   ```

   Если API уязвимо, оно может вернуть список всех пользователей вместо одного. Это может привести к утечке конфиденциальной информации.
 
   Другой вариант атаки – внедрение в мутации:

   ```
   mutation {
     updateUser(id: "1", username: "hacker") {
       username
     }
   }
   ```

   Если сервер не проверяет права доступа, атакующий может изменить данные других пользователей.

3. DDoS-атаки через сложные запросы

   GraphQL позволяет создавать вложенные запросы, что может быть использовано злоумышленниками для перегрузки сервера. Если сервер не ограничивает глубину рекурсивных запросов, злоумышленник может создать бесконечную рекурсию и вызвать отказ в обслуживании.

   Пример атаки:

   ```
   {
     user {
       friends {
         friends {
           friends {
             username
           }
         }
       }
     }
   }
   ```

   Если сервер не настроен на ограничение глубины вложенных запросов, он будет обрабатывать их до полного исчерпания ресурсов.

### Методы защиты

* Отключение **introspection** в продакшене – это предотвратит утечку структуры API.

* Ограничение глубины вложенных запросов с помощью **GraphQL Depth Limit**, чтобы избежать DDoS-атак.

* Фильтрация входных данных с использованием валидации на уровне схемы (GraphQL validation middleware).

* Ограничение скорости запросов (Rate limiting) – предотвращает массовые атаки и перегрузку сервера.

* Настройка аутентификации и авторизации – защита конфиденциальных данных от неавторизованных пользователей.

### Инструменты для тестирования безопасности GraphQL

[GraphQLmap](https://github.com/swisskyrepo/GraphQLmap) – автоматизированный инструмент для тестирования GraphQL API на уязвимости.

![](https://github.com/isohise/kk/blob/main/GraphQL/1.jpg)

[GraphQL Voyager](https://graphql-kit.com/graphql-voyager/) – инструмент для визуализации схем API и поиска потенциальных уязвимостей.

![](https://github.com/isohise/kk/blob/main/GraphQL/2.jpg)

[InQL](https://portswigger.net/bappstore/296e9a0730384be4b2fffef7b4e19b1f) (Burp Suite Plugin) – расширение Burp Suite для анализа GraphQL API и обнаружения скрытых эндпоинтов.

![](https://github.com/isohise/kk/blob/main/GraphQL/3.jpg)

---

### Заключение

**GraphQL** – мощный инструмент для построения API, обеспечивающий гибкость в запросах данных. Однако его особенности могут привести к различным уязвимостям, таким как утечки данных, инъекции и перегрузка сервера сложными запросами. Настройка ограничений на доступ к данным, глубину вложенности запросов и контроль аутентификации помогают минимизировать риски. Понимание возможных атак и использование инструментов тестирования безопасности позволяют выявлять и устранять уязвимости, обеспечивая стабильность и защиту API.
