# Что такое CSRF-уязвимость, как ее находить и к чему она может привести?

## 1. Введение в CSRF

CSRF (Cross-Site Request Forgery) — это уязвимость веб-приложений, при которой злоумышленник может заставить жертву выполнить нежелательные действия на доверенном сайте, на котором она уже авторизована. Это достигается путем отправки специально сформированных запросов от имени пользователя без его ведома.

## 2. Как работает CSRF?

CSRF-атака обычно проходит по следующему сценарию:

1. Пользователь авторизуется на сайте и его сессия сохраняется (например, с помощью cookies).
2. Злоумышленник подготавливает вредоносную ссылку или форму, отправляющую запрос к целевому сайту.
3. Жертва переходит по ссылке или открывает вредоносную страницу, которая автоматически отправляет запрос от ее имени.
4. Сервер принимает запрос, так как он исходит от авторизованного пользователя, и выполняет нежелательное действие (например, перевод денег, изменение пароля, удаление данных и т. д.).

## 3. Как находить CSRF-уязвимости?

### 3.1. Поиск небезопасных методов

CSRF-уязвимости чаще всего возникают в HTTP-запросах методов `GET` и `POST`, если на сервере нет механизма защиты (например, CSRF-токенов).

### 3.2. Использование прокси-инструментов

Инструменты, такие как **Burp Suite** и **OWASP ZAP**, позволяют перехватывать и анализировать запросы. Можно проверить, выполняется ли действие без необходимости указывать CSRF-токен.

### 3.3. Проверка заголовков и токенов

При анализе запросов стоит обратить внимание на наличие `Origin`, `Referer`, а также проверять, требует ли сервер уникальный CSRF-токен в теле запроса.

### 3.4. Тестирование через HTML-формы

Можно создать тестовую форму, которая отправляет запрос к целевому сайту, и проверить, выполняется ли действие без дополнительных проверок.

## 4. Последствия CSRF-атаки

CSRF может привести к следующим последствиям:

- **Кража средств** — атака на банковские системы, переводы денег без ведома пользователя.
- **Изменение учетных данных** — смена пароля, e-mail или других важных данных учетной записи.
- **Изменение настроек аккаунта** — включение вредоносных функций, например, переадресация почты.
- **Удаление данных** — злоумышленник может удалять файлы, учетные записи или важные записи в базе данных.

## 5. Как защититься от CSRF?

### 5.1. CSRF-токены

Добавление CSRF-токенов в запросы делает атаку сложнее, так как злоумышленник не сможет предсказать или получить этот токен.
Пример CSRF-токена в форме:

```html
<input type="hidden" name="csrf_token" value="a1b2c3d4e5">
```

### 5.2. Проверка Origin и Referer

Сервер должен проверять заголовки `Origin` и `Referer`, чтобы убедиться, что запрос действительно исходит от доверенного источника.

### 5.3. Ограничение сессий по IP-адресу

Связывание сессий с IP-адресом пользователя помогает предотвратить атаки с других устройств.

### 5.4. Использование SameSite атрибута для cookies

Настройка cookies с `SameSite=Strict` или `SameSite=Lax` предотвращает их отправку в межсайтовых запросах.

```http
Set-Cookie: sessionid=xyz; Secure; HttpOnly; SameSite=Strict
```

## 6. Обход CSRF-защиты

### 6.1. Обход CSRF-токенов

Некоторые способы обхода CSRF-токенов:

- **Перехват токена через XSS** — если на сайте присутствует XSS-уязвимость, злоумышленник может получить CSRF-токен из страницы и использовать его в атаке.
- **Использование предсказуемых токенов** — если токены генерируются предсказуемо, например, путем инкремента, их можно угадать.
- **Реиспользование старых токенов** — если сервер не проверяет срок действия токена, атакующий может воспользоваться ранее полученным токеном.
- **Атака через CORS** — если сервер неправильно настроил CORS, можно получить CSRF-токен, отправив запрос с разрешенного домена.

### 6.2. Обход ограничений по IP

Ограничение по IP-адресу также можно обойти несколькими способами:

- **Использование прокси-серверов и VPN** — смена IP-адреса позволяет атакующему продолжить атаку.
- **Использование зараженного устройства** — если атакующий контролирует устройство жертвы, он может инициировать запросы с легитимного IP.
- **Эксплуатация CDN и NAT** — если пользователи находятся за NAT или CDN, у всех может быть один IP-адрес, что позволяет атакующему замаскироваться под жертву.
- **Фальсификация заголовков X-Forwarded-For** — некоторые серверы доверяют этому заголовку и используют его для аутентификации IP-адреса.

## 7. Заключение

CSRF — опасная уязвимость, которая позволяет злоумышленникам выполнять действия от имени пользователей. Чтобы предотвратить атаки, необходимо использовать CSRF-токены, проверять заголовки запросов и применять безопасные настройки cookies. Однако защита не всегда идеальна, и существуют способы обхода ограничений. Регулярное тестирование безопасности поможет выявить потенциальные уязвимости и защитить пользователей от атак.
