# Безопасность Wi-Fi сетей: Перехват хендшейков

## Введение

С развитием беспроводных технологий Wi-Fi сети стали неотъемлемой частью нашей повседневной жизни. Однако вместе с удобством подключения к Интернету без проводов возникают и серьезные проблемы безопасности. Одной из наиболее распространенных уязвимостей является возможность перехвата хендшейков — процесса обмена аутентификационными данными между клиентом и точкой доступа.

## Уязвимые протоколы Wi-Fi

Следующие протоколы Wi-Fi имеют уязвимости, связанные с перехватом хендшейков:

1. **WEP (Wired Equivalent Privacy)** — устаревший протокол, который считается полностью скомпрометированным. Его криптографические алгоритмы можно взломать за считанные минуты.

2. **WPA (Wi-Fi Protected Access)** — разработан как временная замена WEP. Использует протокол TKIP (Temporal Key Integrity Protocol), который также имеет серьезные уязвимости.

3. **WPA2-PSK (Pre-Shared Key)** — наиболее распространенный протокол защиты домашних и малых корпоративных сетей. Несмотря на использование более надежного алгоритма шифрования AES-CCMP, подвержен атакам с перехватом хендшейка и последующим подбором пароля.


![image](https://github.com/user-attachments/assets/dfdb1015-afeb-423b-9275-4540e7090bd9)




## Необходимое оборудование и программное обеспечение

Для перехвата Wi-Fi хендшейков обычно требуется:

### Оборудование:
- **Wi-Fi адаптер с поддержкой режима мониторинга** (Monitor Mode) и инъекции пакетов (Packet Injection). Популярные модели:
  - Alfa AWUS036ACH
  - Alfa AWUS036NHA
  - TP-Link TL-WN722N (версии 1.0)
  - Panda PAU06

 ![image](https://github.com/user-attachments/assets/31be4844-7878-40a3-a390-cc8c9add85f4)

- **Компьютер** с операционной системой Linux (предпочтительно Kali Linux, Parrot OS или другой дистрибутив для тестирования на проникновение)

### Программное обеспечение:
- **Aircrack-ng** — набор инструментов для аудита беспроводных сетей
- **Wireshark** — анализатор сетевого трафика
- **Hashcat** или **John the Ripper** — инструменты для подбора паролей
- **Wifite** — автоматизированный инструмент для атак на Wi-Fi
- **Bettercap** — фреймворк для проведения атак типа "человек посередине"

## Алгоритм легитимного подключения к защищенной Wi-Fi сети

![image](https://github.com/user-attachments/assets/5748b675-f527-4550-8a2c-9903d522517f)

При нормальном сценарии подключения к Wi-Fi сети с защитой WPA/WPA2-PSK происходит следующий процесс (4-way handshake):


1. **Обнаружение и ассоциация**:
   - Клиент сканирует эфир и обнаруживает точку доступа по ее SSID
   - Клиент отправляет запрос на ассоциацию (Association Request)
   - Точка доступа отвечает подтверждением ассоциации (Association Response)

2. **Четырехэтапный хендшейк (4-way handshake)**:
   - **Сообщение 1**: Точка доступа отправляет клиенту случайное число (ANonce)
   - **Сообщение 2**: Клиент генерирует свое случайное число (SNonce) и создает временный ключ шифрования PTK (Pairwise Transient Key) на основе:
     * PMK (Pairwise Master Key) — производная от пароля сети (PSK)
     * ANonce и SNonce (случайные числа)
     * MAC-адресов клиента и точки доступа
     * SSID сети
     Затем клиент отправляет SNonce и MIC (Message Integrity Code) точке доступа
   - **Сообщение 3**: Точка доступа проверяет MIC, формирует свой PTK, и отправляет клиенту GTK (Group Temporal Key) для многоадресных передач
   - **Сообщение 4**: Клиент подтверждает получение GTK и завершает хендшейк

3. **Установление защищенного соединения**:
   - После успешного хендшейка клиент и точка доступа используют согласованные ключи для шифрования трафика
   

## Процесс атаки для перехвата хендшейка

Атака на Wi-Fi сеть с целью перехвата хендшейка может выполняться двумя способами:

### 1. Пассивный перехват

В этом режиме атакующий просто прослушивает эфир в ожидании легитимного хендшейка:

1. Включение режима мониторинга на Wi-Fi адаптере:
   ```
   airmon-ng start wlan0
   ```

2. Прослушивание эфира и захват пакетов для выбранной сети:
   ```
   airodump-ng -c [канал] --bssid [MAC точки доступа] -w [файл вывода] wlan0mon
   ```

![image](https://github.com/user-attachments/assets/0b0b03ff-e032-4332-8e66-33a1f5be5731)


3. Ожидание момента, когда какой-либо клиент подключится к сети или переподключится к ней

4. Захваченный хендшейк сохраняется для последующего анализа

Пассивный перехват может занять много времени, если никто активно не подключается к сети, но он полностью незаметен для пользователей и не оставляет следов в системных журналах.

### 2. Активный перехват с использованием deauth-атаки

Этот метод значительно ускоряет получение хендшейка за счет принудительного отключения клиентов от сети:

1. Включение режима мониторинга и сканирование доступных сетей:
   ```
   airmon-ng start wlan0
   airodump-ng wlan0mon
   ```

2. Запуск целевого мониторинга для захвата хендшейка:
   ```
   airodump-ng -c [канал] --bssid [MAC точки доступа] -w [файл вывода] wlan0mon
   ```

3. Одновременное отправление deauth-пакетов для отключения клиентов:
   ```
   aireplay-ng --deauth [количество пакетов] -a [MAC точки доступа] -c [MAC клиента] wlan0mon
   ```
   
   ![image](https://github.com/user-attachments/assets/ae1451ac-6d4a-4cd6-8b48-27da84f08f2b)

   Можно отправить deauth всем клиентам, опустив параметр `-c [MAC клиента]`

4. Захват хендшейка при повторном подключении клиентов

5. Проверка наличия хендшейка в захваченном файле:
   ```
   aircrack-ng [файл вывода]-01.cap
   ```

## Подробнее о deauth-пакетах

Deauthentication (деаутентификация) — это часть стандарта IEEE 802.11, предназначенная для корректного завершения сессии с клиентом. В нормальных условиях deauth-пакеты используются в следующих случаях:
- Когда клиент хочет отключиться от сети
- Когда точка доступа хочет принудительно отключить клиента (например, при неактивности)
- При изменении параметров сети

### Как работают deauth-пакеты:

1. **Структура пакета**: Deauth-пакет — это управляющий фрейм 802.11 с кодом типа 0xC0 (деаутентификация).

2. **Поля пакета**:
   - MAC-адрес отправителя (подделывается под MAC-адрес точки доступа)
   - MAC-адрес получателя (MAC клиента или широковещательный адрес)
   - Код причины отключения (обычно 7 — "Отключение из-за неактивности")
  
![image](https://github.com/user-attachments/assets/c66d6aa6-a1c1-40a2-bc9f-4d7bc0bbec36)

3. **Механизм действия**: Когда клиент получает такой пакет, он считает, что точка доступа запросила разрыв соединения, и инициирует процедуру переподключения, включающую новый хендшейк.

![image](https://github.com/user-attachments/assets/15775599-98b5-4278-aa04-b05ef256439d)


4. **Особенности уязвимости**:
   - Deauth-пакеты не требуют аутентификации или шифрования
   - Протокол IEEE 802.11 предусматривает обязательное выполнение команды деаутентификации
   - MAC-адрес отправителя легко подделать (MAC spoofing)

Эта уязвимость существует во всех версиях Wi-Fi, включая WPA2, и была частично устранена только в WPA3 с внедрением Protected Management Frames (PMF).

## Анатомия Wi-Fi хендшейка

Хендшейк — это процесс обмена криптографической информацией для установления безопасного соединения. В контексте WPA/WPA2-PSK это 4-way handshake, состоящий из четырех EAPOL-пакетов (Extensible Authentication Protocol over LAN).

### Из чего формируется хендшейк:

1. **Pre-Shared Key (PSK)** — 256-битный ключ, полученный из пароля сети и SSID с помощью функции PBKDF2-HMAC-SHA1:
   - PSK = PBKDF2(пароль, SSID, 4096, 256)
   где 4096 — количество итераций хэширования

2. **Pairwise Master Key (PMK)** — в случае WPA/WPA2-PSK является тем же PSK

3. **Nonces (случайные числа)**:
   - ANonce — случайное число, генерируемое точкой доступа
   - SNonce — случайное число, генерируемое клиентом

4. **Pairwise Transient Key (PTK)** — временный ключ сессии, формируемый по формуле:
   - PTK = PRF(PMK, "Pairwise key expansion", Min(AP-MAC, Client-MAC) || Max(AP-MAC, Client-MAC) || Min(ANonce, SNonce) || Max(ANonce, SNonce))
   где PRF — псевдослучайная функция, основанная на HMAC-SHA1

5. **Message Integrity Check (MIC)** — код целостности сообщения, вычисляемый с использованием части PTK

### Как хэшируется и хранится хендшейк:

При захвате хендшейка атакующий получает:
- SSID сети
- MAC-адреса точки доступа и клиента
- ANonce и SNonce
- MIC (Message Integrity Check)

Эти данные сохраняются в формате PCAP (Packet Capture) или HCCAPX (формат для Hashcat) и содержат всю информацию, необходимую для проведения брутфорс-атаки.

### Процесс расшифровки (подбора пароля):

1. Атакующий извлекает из захваченного хендшейка все необходимые параметры
2. Для каждого пароля-кандидата из словаря:
   - Вычисляется PSK = PBKDF2(пароль-кандидат, SSID, 4096, 256)
   - Вычисляется PTK на основе PSK, ANonce, SNonce и MAC-адресов
   - Вычисляется MIC и сравнивается с перехваченным значением
   - Если MIC совпадает, пароль найден

Для ускорения подбора используются:
- Словари паролей
- Правила мутации паролей
- GPU-ускорение (через Hashcat)

Типичная команда для подбора пароля:
```
hashcat -m 22000 -a 0 captured.hccapx wordlist.txt
```

## Мотивация злоумышленников: сценарии атак

### 1. Проникновение в сеть объекта

Несанкционированный доступ к Wi-Fi сети может быть первым шагом для проникновения в корпоративную инфраструктуру. После подключения к Wi-Fi атакующий может:
- Обойти периметровую защиту
- Получить доступ к внутренним ресурсам
- Провести разведку внутренней сети
- Атаковать системы, доступные только внутри сети
- Установить постоянный доступ (persistence)

### 2. Анонимизация

Доступ к чужой Wi-Fi сети позволяет злоумышленнику скрыть свою личность при проведении атак:
- Действия будут связаны с IP-адресом владельца сети, а не атакующего
- Затрудняется отслеживание и расследование инцидентов
- Создается дополнительный слой анонимности, особенно в сочетании с другими методами (VPN, Tor)

### 3. Заражение устройств в локальной сети

Находясь внутри сети, атакующий может:
- Проводить атаки типа ARP-spoofing для перехвата трафика
- Внедрять вредоносное ПО на устройства в сети
- Устанавливать перехватчики паролей (password sniffers)
- Проводить атаки типа "человек посередине" (MITM)
- Использовать уязвимости в протоколах локальной сети (SMB, NBNS, LLMNR)

### 4. Сбор информации об устройствах

Wi-Fi сеть часто содержит множество устройств, которые могут стать целями для атак:
- Картографирование сети (определение активных хостов)
- Определение типов устройств и используемых ОС
- Выявление уязвимых устройств (IoT, устаревшее ПО)
- Сбор учетных данных при прослушивании трафика
- Выявление потенциальных векторов для дальнейших атак

## Методы защиты от атак

### 1. Усиление защиты Wi-Fi

- **Использование сложных паролей**: не менее 12 символов, включая буквы разного регистра, цифры и специальные символы
- **Переход на WPA3** там, где это возможно
- **Включение Protected Management Frames (PMF)** для защиты от deauth-атак
- **Скрытие SSID** (малоэффективно, но создает дополнительное препятствие)
- **Регулярная смена паролей** Wi-Fi сетей
- **Использование Enterprise-версий WPA2/WPA3** с индивидуальной аутентификацией пользователей (802.1X, RADIUS)



### 2. Контроль доступа по MAC-адресам

Настройка точки доступа для работы только с известными MAC-адресами:
- Создание "белого списка" разрешенных устройств
- Регистрация MAC-адресов всех легитимных устройств
- Регулярная ревизия списка разрешенных устройств

Однако этот метод обеспечивает лишь базовый уровень защиты, так как MAC-адреса можно подделать.

### 3. Защита на уровне DHCP

- **Статическая привязка IP-адресов к MAC-адресам** в настройках DHCP-сервера
- **DHCP snooping** — технология, которая различает легитимные и поддельные DHCP-сообщения
- **IP Source Guard** — предотвращение IP-спуфинга путем проверки соответствия IP и MAC
- **Dynamic ARP Inspection (DAI)** — защита от ARP-спуфинга

### 4. Сегментация сети

- **Разделение на VLAN** для изоляции групп устройств
- **Гостевая сеть** для временных пользователей
- **Network Access Control (NAC)** для аутентификации устройств перед предоставлением доступа к сети
- **Использование 802.1X** для портового контроля доступа

### 5. Мониторинг и обнаружение атак

- **Wireless Intrusion Prevention Systems (WIPS)** для обнаружения атак на Wi-Fi
- **Анализ сетевого трафика** для выявления подозрительной активности
- **Мониторинг журналов точек доступа** на предмет необычных событий
- **Регулярные аудиты безопасности** Wi-Fi сетей

### 6. Организационные меры

- **Политика безопасности** для Wi-Fi сетей
- **Обучение пользователей** основам безопасности
- **Ограничение зоны покрытия Wi-Fi** (регулировка мощности передатчиков)
- **Физическая безопасность** точек доступа
- **Отключение неиспользуемых Wi-Fi сетей** в нерабочее время

## Заключение

Атаки на Wi-Fi сети с перехватом хендшейков остаются одной из наиболее распространенных угроз безопасности. Протоколы WEP, WPA и WPA2-PSK имеют фундаментальные уязвимости, которые позволяют атакующим получить доступ к защищенным сетям при условии перехвата хендшейка и успешного подбора пароля.

Для защиты от таких атак критически важно использовать сложные пароли, современные протоколы безопасности (WPA3), комбинировать различные методы контроля доступа и регулярно проводить аудит безопасности Wi-Fi инфраструктуры. Комплексный подход к безопасности является единственным эффективным способом противодействия современным угрозам в области беспроводных технологий.
